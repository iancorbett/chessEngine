<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JS Chess Engine (vs You)</title>
  <!-- Chessboard.js styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css">
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; }
    #board { width: 420px; margin-bottom: 12px; }
    #log { white-space: pre-wrap; font-family: ui-monospace, monospace; }
    button { padding: 8px 12px; }
  </style>
</head>
<body>
  <h1>Play vs JS Engine</h1>
  <div id="board"></div>
  <button id="newGame">New Game</button>
  <span style="margin-left:8px">Engine time: <input id="thinkMs" type="number" value="1200" style="width:80px"> ms</span>
  <div id="log"></div>

  <!-- chess.js (rules / legality) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
  <!-- chessboard.js (UI board) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
    // Worker (engine) â€” make sure engine.worker.js is in the same folder
    const engine = new Worker('engine.worker.js');

    const game = new Chess();
    const board = Chessboard('board', {
      position: 'start',
      draggable: true,
      pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/img/chesspieces/wikipedia/{piece}.png',
      onDrop: onDrop,
      onSnapEnd: onSnapEnd
    });

    const log = document.getElementById('log');
    const thinkMsEl = document.getElementById('thinkMs');

    function appendLog(t){ log.textContent = (t + '\n' + log.textContent).slice(0, 4000); }

    function onDrop(source, target) {
      // Try to make the user move in chess.js (validates legality)
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (!move) return 'snapback'; // illegal, snap back
      board.position(game.fen());   // sync UI
      appendLog(`You: ${move.san}`);

      // Now ask engine to move
      thinkForEngine();
    }

    function onSnapEnd() {
      // ensure board matches game after piece animation
      board.position(game.fen());
    }

    function thinkForEngine() {
      if (game.game_over()) return;
      engine.postMessage({
        type: 'go',
        fen: game.fen(),
        timeMs: Number(thinkMsEl.value) || 1000,
        depth: 6
      });
    }

    engine.onmessage = (e) => {
      const msg = e.data || {};
      if (msg.type === 'bestmove') {
        if (!msg.uci) return;
        const from = msg.uci.slice(0,2);
        const to   = msg.uci.slice(2,4);
        const promo = msg.uci.slice(4) || undefined;
        const made = game.move({ from, to, promotion: promo });
        if (made) {
          board.position(game.fen());
          appendLog(`Engine: ${made.san}  (score ${msg.scoreCp}, nodes ${msg.nodes})`);
        }
      } else if (msg.type === 'error') {
        appendLog('Engine error: ' + msg.error);
      }
    };

    document.getElementById('newGame').onclick = () => {
      game.reset();
      board.start();
      log.textContent = '';
    };
  </script>
</body>
</html>
